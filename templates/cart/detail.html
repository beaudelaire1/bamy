{% extends "base.html" %}
{% load static %}
{% block content %}
  <!-- Fil d’Ariane -->
  <nav class="text-sm mb-4" aria-label="Fil d’Ariane">
    <ol class="flex items-center space-x-1 text-gray-500">
      <li><a href="{% url 'core:home' %}" class="hover:underline">Accueil</a></li>
      <li>/</li>
      <li>Panier</li>
    </ol>
  </nav>
<section class="rounded-2xl p-6 bg-white shadow-lg max-w-4xl mx-auto my-8">
  <h1 class="text-2xl font-bold text-gray-800 mb-6">Votre panier</h1>

  {% if cart_count == 0 %}
    <div class="text-center py-12">
      <p class="text-gray-600 mb-4">Votre panier est vide.</p>
      <a href="{% url 'catalog:product_list' %}"
         class="inline-block px-6 py-3 rounded-lg text-white font-medium transition-colors"
         style="background: var(--brand-primary);">
        Continuer vos achats
      </a>
    </div>
  {% else %}
    <!--
      Si l'utilisateur n'est pas connecté ou n'est pas vérifié, les prix
      du panier ne doivent pas apparaître.  On affiche seulement les
      informations de produit et de quantité ainsi qu'un message invitant à
      se connecter ou à contacter l'équipe commerciale pour obtenir un devis.
    -->
    {% if not request.user.is_authenticated %}
      <div class="text-center py-12 text-gray-700">
        <p class="mb-4">Les prix et le paiement sont réservés aux utilisateurs connectés.</p>
        <p class="mb-4">Veuillez vous connecter pour afficher les tarifs ou <a href="{% url 'crm:contact' %}" class="text-brand-primary underline">contactez‑nous</a> pour obtenir un devis.</p>
      </div>
    {% else %}
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Produit
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Prix unitaire
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Quantité
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Sous-total
              </th>
              <th scope="col" class="px-6 py-3"></th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for item in cart %}
              {% with product=item.product %}
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div>
                      <div class="text-sm font-medium text-gray-900">
                        <a href="{{ product.get_absolute_url }}" class="hover:underline">{{ product.title }}</a>
                      </div>
                      {% if product.sku %}
                        <div class="text-xs text-gray-500">SKU: {{ product.sku }}</div>
                      {% endif %}
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {{ item.price|floatformat:2 }} €
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <!-- Utilise la route d'update explicite pour modifier la quantité. -->
                    <form action="{% url 'cart:cart_update' product.id %}" method="post" class="flex items-center gap-2 js-qty-form">
                      {% csrf_token %}
                      <button type="button"
                              class="qty-btn minus js-qty-minus hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-primary"
                              aria-label="Diminuer la quantité">
                        −
                      </button>
                      <input
                        type="number"
                        name="qty"
                        value="{{ item.quantity }}"
                        min="1"
                        {% if product.stock %}max="{{ product.stock }}"{% endif %}
                        class="qty-input w-16 text-center border-gray-300 focus:ring-brand-primary focus:border-brand-primary"
                        aria-label="Quantité">
                      <button type="button"
                              class="qty-btn plus js-qty-plus hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-primary"
                              aria-label="Augmenter la quantité">
                        +
                      </button>
                      <!-- Pas besoin de champ override pour update. -->
                      <button type="submit"
                              class="btn-update ml-2 px-3 py-1.5 text-xs font-medium text-white rounded-md shadow-sm hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-primary">
                        Mettre à jour
                      </button>
                    </form>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    {{ item.total_price|floatformat:2 }} €
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <a href="{% url 'cart:cart_remove' product.id %}"
                       class="text-red-600 hover:text-red-900 font-medium">
                      Retirer
                    </a>
                  </td>
                </tr>
              {% endwith %}
            {% endfor %}
          </tbody>
          <tfoot class="bg-gray-50">
            <tr>
              <td colspan="3" class="px-6 py-3 text-right text-sm font-bold text-gray-900 uppercase">Total</td>
              <td class="px-6 py-3 text-sm font-bold text-gray-900">{{ cart.total|floatformat:2 }} €</td>
              <td></td>
            </tr>
            {% if discount_amount and discount_amount > 0 %}
            <tr>
              <td colspan="3" class="px-6 py-2 text-right text-sm text-gray-700">Remise ({{ coupon_obj.code }})</td>
              <td class="px-6 py-2 text-sm text-gray-700">-{{ discount_amount|floatformat:2 }} €</td>
              <td></td>
            </tr>
            <tr>
              <td colspan="3" class="px-6 py-3 text-right text-sm font-bold text-gray-900 uppercase">Total après remise</td>
              <td class="px-6 py-3 text-sm font-bold text-gray-900">{{ total_after_discount|floatformat:2 }} €</td>
              <td></td>
            </tr>
            {% endif %}
          </tfoot>
        </table>
      </div>
    {% endif %}

    <div class="mt-8">
      <!-- Formulaire de code promo -->
      <form method="post" action="{% url 'cart:apply_coupon' %}" class="mb-6 flex flex-col sm:flex-row gap-3 items-start sm:items-end">
        {% csrf_token %}
        <div class="flex-1">
          <label for="coupon_code" class="block text-sm font-medium text-gray-700 mb-1">Code promo</label>
          <input type="text" name="coupon_code" id="coupon_code" value="{{ coupon_code }}"
                 class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-brand-primary focus:border-brand-primary" placeholder="Saisissez votre code promo">
        </div>
        <div>
          <button type="submit" class="px-4 py-2 rounded-md text-white font-medium" style="background:var(--brand-primary)">Appliquer</button>
        </div>
      </form>
      <div class="flex flex-col sm:flex-row justify-end gap-4">
        <a href="{% url 'catalog:product_list' %}"
           class="px-6 py-3 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-primary text-center">
          Continuer vos achats
        </a>
        <a href="{% url 'orders:checkout' %}"
           class="px-6 py-3 rounded-lg text-sm font-medium text-white shadow-sm hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-primary text-center"
           style="background: var(--brand-primary);">
          Passer au paiement
        </a>
      </div>
    </div>
  {% endif %}
</section>
{% endblock %}
{% block scripts %}
  {{ block.super }}
  <!-- Script de gestion des boutons +/− du panier -->
  <script src="{% static 'js/cart.js' %}"></script>
{% endblock %}
