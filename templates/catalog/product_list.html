{% extends "base.html" %}
{% load static %}

{% block content %}
<section class="mb-6">
  <h1 class="text-2xl font-semibold">Catalogue</h1>
  <p class="text-gray-600">Filtrez par catégorie, marque et prix. Triez et parcourez nos produits.</p>
</section>

<form method="get" class="lux-glass p-4 mb-6">
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 items-end">
    <!-- Recherche libre -->
    <div class="lg:col-span-2">
      <label class="block text-sm text-gray-700 mb-1">Recherche</label>
      <input
        type="text"
        name="query"
        value="{{ form.query.value|default_if_none:'' }}"
        class="w-full rounded-lg border px-3 py-2"
        placeholder="Nom, code article ou EAN"
      >
    </div>

    <!-- Catégorie -->
    <div class="lg:col-span-2">
      <label class="block text-sm text-gray-700 mb-1">Catégorie</label>
      <select name="category" class="w-full rounded-lg border px-3 py-2">
        <option value="">{% firstof form.fields.category.empty_label "Toutes les catégories" %}</option>
        {% for c in form.fields.category.queryset %}
          {% with sel=form.category.value|stringformat:"s" %}
            <option value="{{ c.pk }}" {% if sel == c.pk|stringformat:"s" %}selected{% endif %}>{{ c.name }}</option>
          {% endwith %}
        {% endfor %}
      </select>
    </div>

    <!-- Marque -->
    <div class="lg:col-span-2">
      <label class="block text-sm text-gray-700 mb-1">Marque</label>
      <select name="brand" class="w-full rounded-lg border px-3 py-2">
        <option value="">{% firstof form.fields.brand.empty_label "Toutes les marques" %}</option>
        {% for b in form.fields.brand.queryset %}
          {% with sel=form.brand.value|stringformat:"s" %}
            <option value="{{ b.pk }}" {% if sel == b.pk|stringformat:"s" %}selected{% endif %}>{{ b.name }}</option>
          {% endwith %}
        {% endfor %}
      </select>
    </div>

    <!-- Prix min -->
    <div>
      <label class="block text-sm text-gray-700 mb-1">Prix min (€)</label>
      <input
        type="number" step="0.01" inputmode="decimal"
        name="min_price"
        value="{{ form.min_price.value|default_if_none:'' }}"
        min="{{ price_min_db }}" max="{{ price_max_db }}"
        class="w-full rounded-lg border px-3 py-2"
        placeholder="{{ price_min_db }}"
      >
    </div>

    <!-- Prix max -->
    <div>
      <label class="block text-sm text-gray-700 mb-1">Prix max (€)</label>
      <input
        type="number" step="0.01" inputmode="decimal"
        name="max_price"
        value="{{ form.max_price.value|default_if_none:'' }}"
        min="{{ price_min_db|floatformat }}" max="{{ price_max_db|floatformat }}"
        class="w-full rounded-lg border px-3 py-2"
        placeholder="{{ price_max_db }}"
      >
      {% if form.max_price.errors %}
        <p class="text-sm text-red-600 mt-1">{{ form.max_price.errors.0 }}</p>
      {% endif %}
    </div>
  </div>

  <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 items-end">
    <!-- Tri -->
    <div class="lg:col-span-2">
      <label class="block text-sm text-gray-700 mb-1">Trier par</label>
      <select name="sort" class="w-full rounded-lg border px-3 py-2">
        <option value="" {% if not current_sort %}selected{% endif %}>Pertinence</option>
        <option value="recent" {% if current_sort == 'recent' %}selected{% endif %}>Plus récents</option>
        <option value="price_asc" {% if current_sort == 'price_asc' %}selected{% endif %}>Prix croissant</option>
        <option value="price_desc" {% if current_sort == 'price_desc' %}selected{% endif %}>Prix décroissant</option>
      </select>
    </div>

    <!-- Actions -->
    <div class="lg:col-span-4 flex gap-2">
      <button type="submit" class="btn primary">Appliquer</button>
      <a href="{% url 'catalog:product_list' %}" class="btn ghost">Réinitialiser</a>
    </div>
  </div>

  <!-- Aide bornes DB -->
  <p class="text-xs text-gray-500 mt-2">
    Prix disponibles (après filtre Catégorie/Marque) : {{ price_min_db|floatformat }} € — {{ price_max_db|floatformat  }} €
  </p>
</form>

<!-- Grille produits -->
<div class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
  {% for product in products %}
    {% include "catalog/_product_card.html" with product=product %}
  {% empty %}
    <p class="text-gray-500">Aucun produit ne correspond à vos critères.</p>
  {% endfor %}
</div>

<!-- Pagination -->
{% if products.paginator.num_pages > 1 %}
  <nav class="mt-8 flex items-center justify-center gap-2" aria-label="Pagination">
    {% if products.has_previous %}
      <a class="px-3 py-2 rounded-lg border" href="?{% if qstring %}{{ qstring }}&{% endif %}page={{ products.previous_page_number }}">Précédent</a>
    {% endif %}
    <span class="px-3 py-2 text-sm text-gray-600">Page {{ products.number }} / {{ products.paginator.num_pages }}</span>
    {% if products.has_next %}
      <a class="px-3 py-2 rounded-lg border" href="?{% if qstring %}{{ qstring }}&{% endif %}page={{ products.next_page_number }}">Suivant</a>
    {% endif %}
  </nav>
{% endif %}
{% endblock %}
