<!-- templates/catalog/_product_card.html -->
{% load catalog_extras %}
<article class="card group relative">

  <!-- Wishlist -->
  <button type="button"
          class="absolute top-2 right-2 z-10 p-2 rounded-xl bg-white/80 hover:bg-white"
          aria-label="Ajouter aux favoris"
          data-wish-id="{{ product.id }}">
    <svg viewBox="0 0 24 24" class="w-5 h-5">
      <path d="M12 21s-7.5-4.7-9.7-8.5C-0.2 8.6 2 4 6 4c2 0 3.6 1.3 4.5 2.6C11.4 5.3 13 4 15 4c4 0 6.2 4.6 3.7 8.5C19.5 16.3 12 21 12 21z" fill="currentColor"/>
    </svg>
  </button>

  {% if product.is_promo %}
    <span class="ribbon-promo">Promo</span>
  {% endif %}

  <a href="{{ product.get_absolute_url }}" class="block">
    <div class="aspect-[4/3] bg-gray-100 overflow-hidden">
      {% if product.image %}
        <img src="{{ product.image.url }}"
             alt="{{ product.title }}"
             loading="lazy"
             class="w-full h-full object-contain transition group-hover:scale-105">
      {% endif %}
    </div>

    <div class="p-4">
      <div class="text-xs text-gray-500 flex items-center gap-2">
        {% if product.brand.logo %}
          <img src="{{ product.brand.logo.url }}" alt="{{ product.brand.name }}" loading="lazy" class="w-4 h-4 rounded">
        {% endif %}
        {{ product.brand.name }} • {{ product.category.name }}
      </div>

      <h3 class="mt-1 font-medium line-clamp-2">{{ product.title }}</h3>

      <!-- Prix et unité -->
      <div class="mt-2">
        {% if request.user.is_authenticated %}
          <!-- Affiche un prix ajusté en fonction de la catégorie de client.  Le
             calcul est centralisé via le filtre ``price_for_user`` qui
             applique les remises pour les grossistes ou distributeurs. -->
          {% with user_price=product|price_for_user:request.user %}
            {% if user_price %}
              <div class="text-lg font-semibold text-brand">{{ user_price }} €</div>
            {% else %}
              <div class="text-lg font-semibold text-brand">—</div>
            {% endif %}
          {% endwith %}
        {% else %}
          <!-- Prix masqué pour les visiteurs ou comptes non validés -->
          <div class="text-sm text-gray-500">Connectez‑vous pour voir les prix</div>
          <div class="mt-1">
            <a href="{% url 'crm:quote_request' %}?product={{ product.id }}" class="text-brand underline text-sm">Demander un devis</a>
          </div>
        {% endif %}
        {% if product.unit %}
          <div class="text-xs text-gray-500">{{ product.unit }}</div>
        {% endif %}
      </div>
    </div>
  </a>

  <!-- Ajouter au panier + Quantité (MOQ + PCB intégrés) -->
  <form class="add-to-cart p-3 pt-0" method="post" action="{% url 'cart:cart_add' product.id %}">
    {% csrf_token %}

    <div class="qty-wrap">
      <label class="qty-label">Quantité</label>
      <div class="qty-control">
        <!-- Les boutons +/- exploitent l’attribut step du champ -->
        <button type="button" class="qty-btn" onclick="
          const i=this.nextElementSibling; i.stepDown(); i.dispatchEvent(new Event('change'));
        " aria-label="Diminuer">−</button>

        <input
          class="qty-input"
          type="number"
          name="quantity"
          value="{{ product.initial_order_qty }}"
          min="{{ product.initial_order_qty }}"
          {% if product.order_in_packs and product.pcb_qty > 1 %}
            step="{{ product.pcb_qty }}"
          {% else %}
            step="1"
          {% endif %}
          {% if product.stock %}max="{{ product.stock }}"{% endif %}
          inputmode="numeric"
          pattern="[0-9]*"
          aria-label="Quantité"
        >

        <button type="button" class="qty-btn" onclick="
          const i=this.previousElementSibling; i.stepUp(); i.dispatchEvent(new Event('change'));
        " aria-label="Augmenter">+</button>
      </div>

      <!-- Aide sur les contraintes de quantité -->
      {% if product.order_in_packs and product.pcb_qty > 1 %}
        <p class="text-xs text-gray-500 mt-1">
          Vendu par lots de {{ product.pcb_qty }}. Minimum {{ product.min_order_qty }}.
        </p>
      {% else %}
        <p class="text-xs text-gray-500 mt-1">
          Quantité minimale : {{ product.min_order_qty }}.
        </p>
      {% endif %}
    </div>

    <!-- Si tu veux remplacer la quantité existante au lieu d'additionner, passe override=True -->
    <input type="hidden" name="override" value="False">

    <button type="submit" class="w-full px-3 py-2 rounded-xl text-white" style="background:var(--brand-primary)">
      Ajouter au panier
    </button>
  </form>
</article>
