<!-- templates/partials/navbar.html -->
<nav class="site-nav" aria-label="Navigation principale">
  <!-- Colonne gauche : logo / marque -->
  <div class="nav-left">
    <a href="{% url 'core:home' %}" class="brand">
      {{ COMPANY_NAME|default:"BamyTest" }}
    </a>
  </div>

  <!-- Menu burger (mobile) -->
  <button id="nav-toggle" class="nav-burger" aria-label="Menu" aria-expanded="false" aria-controls="nav-menu">
    <span class="burger-bar"></span>
    <span class="burger-bar"></span>
    <span class="burger-bar"></span>
  </button>

  <!-- Liens principaux -->
  <ul id="nav-menu" class="nav-menu">
    <!--
      Nouvelle navigation structurée en mega‑menus.
      Le logo à gauche sert de lien vers l'accueil, il n'est donc plus
      nécessaire d'avoir un lien "Accueil" dans la liste. Trois menus
      principaux regroupent les liens par thématique : Produits, Services
      et Entreprise. Chaque sous‑menu apparaît au survol.
    -->
    <!-- Menu Produits -->
    <li class="relative group">
      <a class="nav-link flex items-center gap-1" href="{% url 'catalog:product_list' %}" aria-haspopup="true">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        <span>Produits</span>
      </a>
      {% if nav_categories %}
      <div class="absolute left-0 mt-2 w-64 rounded-xl shadow-lg ring-1 ring-black/5 hidden group-hover:block z-50 p-4"
           style="background: var(--surface, #ffffff);">
        <h3 class="text-sm font-semibold text-gray-700 mb-2">Catégories</h3>
        <ul class="space-y-1 mb-3">
          {% for cat in nav_categories %}
            <li>
              <a href="{{ cat.get_absolute_url }}" class="block px-2 py-1 text-sm text-gray-900 hover:bg-gray-100 hover:text-brand-primary rounded">
                {{ cat.name }}
              </a>
            </li>
          {% endfor %}
        </ul>
        <a href="{% url 'catalog:product_list' %}" class="block px-2 py-2 text-sm font-medium text-white text-center rounded" style="background: var(--brand-primary);">Tous les produits</a>
      </div>
      {% endif %}
    </li>
    <!-- Menu Services -->
    <li class="relative group">
      <a class="nav-link flex items-center gap-1" href="#" aria-haspopup="true">
        <!-- Icône services (cog) -->
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        <span>Services</span>
      </a>
      <div class="absolute left-0 mt-2 w-56 rounded-xl shadow-lg ring-1 ring-black/5 hidden group-hover:block z-50"
           style="background: var(--surface, #ffffff);">
        <ul class="py-2">
          <li><a href="{% url 'catalog:week_selection' %}" class="block px-4 py-2 text-sm text-gray-900 hover:bg-gray-100 hover:text-brand-primary">Sélection semaine</a></li>
          <!-- Lien contact mis à jour : l'app CRM est supprimée -->
          <li><a href="{% url 'core:contact' %}" class="block px-4 py-2 text-sm text-gray-900 hover:bg-gray-100 hover:text-brand-primary">Contact</a></li>
          <!-- Le module notifications a été supprimé, on retire le lien pour éviter les erreurs -->
          <li><a href="{% url 'returns:policy' %}" class="block px-4 py-2 text-sm text-gray-900 hover:bg-gray-100 hover:text-brand-primary">Politique de retour</a></li>
          <li><a href="{% url 'loyalty:program' %}" class="block px-4 py-2 text-sm text-gray-900 hover:bg-gray-100 hover:text-brand-primary">Programme fidélité</a></li>
        </ul>
      </div>
    </li>
    <!-- Menu Entreprise -->
    <li class="relative group">
      <a class="nav-link flex items-center gap-1" href="#" aria-haspopup="true">
        <!-- Icône info cercle -->
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
        <span>Entreprise</span>
      </a>
      <div class="absolute left-0 mt-2 w-56 rounded-xl shadow-lg ring-1 ring-black/5 hidden group-hover:block z-50"
           style="background: var(--surface, #ffffff);">
        <ul class="py-2">
          <li><a href="{% url 'core:about' %}" class="block px-4 py-2 text-sm text-gray-900 hover:bg-gray-100 hover:text-brand-primary">À propos</a></li>
          <li><a href="{% url 'core:contact' %}" class="block px-4 py-2 text-sm text-gray-900 hover:bg-gray-100 hover:text-brand-primary">Contact</a></li>
          <li><a href="{% url 'recruitment:job_list' %}" class="block px-4 py-2 text-sm text-gray-900 hover:bg-gray-100 hover:text-brand-primary">Recrutement</a></li>
          <li><a href="{% url 'core:privacy' %}" class="block px-4 py-2 text-sm text-gray-900 hover:bg-gray-100 hover:text-brand-primary">Confidentialité</a></li>
          <li><a href="{% url 'core:cookies' %}" class="block px-4 py-2 text-sm text-gray-900 hover:bg-gray-100 hover:text-brand-primary">Cookies</a></li>
        </ul>
      </div>
    </li>
  </ul>

  <!-- Colonne droite : actions -->
  <div class="nav-right">
    <!-- Bouton mode sombre/clair -->
    <button type="button" id="theme-toggle" class="icon-btn mr-2" aria-label="Basculer thème">
      <!-- Icône soleil/lune, affichée via CSS/JS (soleil par défaut) -->
      <svg id="theme-icon" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="5" />
        <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
      </svg>
    </button>
    <!-- Barre de recherche (desktop) -->
    <form action="{% url 'catalog:product_list' %}" method="get" class="hidden lg:block mr-4">
      <label for="nav-search" class="sr-only">Rechercher</label>
      <input id="nav-search" name="query" type="search" placeholder="Rechercher..."
             class="px-3 py-2 w-64 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-brand-primary focus:border-brand-primary text-sm" />
    </form>
    <!-- Wishlist -->
    <div class="nav-action" id="nav-wishlist">
      <button type="button" class="icon-btn" aria-label="Favoris">
        <!-- Icône cœur moderne agrandie -->
        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20.8 4.6a5.5 5.5 0 0 0-7.8 0L12 5.6l-1-1a5.5 5.5 0 0 0-7.8 7.8l1 1L12 21l7.8-7.6 1-1a5.5 5.5 0 0 0 0-7.8z"/>
        </svg>
        <span id="wishlist-badge" class="badge" style="display:none;">0</span>
      </button>
      <div class="panel" id="wishlist-panel" style="display:none">
        <p class="panel-title">Favoris : <span id="wishlist-count">0</span></p>
        <a href="{% url 'catalog:wishlist' %}" class="panel-link" id="wishlist-open">Voir mes favoris</a>
      </div>
    </div>

    <!-- Panier -->
    <div class="nav-action" id="nav-cart">
      <a href="{% url 'cart:detail' %}" class="icon-btn" aria-label="Panier">
        <!-- Icône panier moderne agrandie -->
        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="9" cy="21" r="1"/>
          <circle cx="20" cy="21" r="1"/>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
        </svg>
        <span class="badge">{{ cart_count|default:0 }}</span>
      </a>
      <div class="panel" id="cart-panel" style="display:none">
        <p class="panel-title">Panier : <strong>{{ cart_count|default:0 }}</strong> article(s)</p>
        {% if request.user.is_authenticated %}
          <p class="panel-sub">Total : <strong>{{ cart_total|default:"0.00" }} €</strong></p>
        {% else %}
          <p class="panel-sub text-sm text-gray-500">Connectez‑vous pour voir le total</p>
        {% endif %}
        <div class="panel-actions">
          <!-- Accéder au panier complet -->
          <a href="{% url 'cart:detail' %}" class="btn ghost">Voir panier</a>
          {% if request.user.is_authenticated %}
            <!-- Bouton primaire : accéder au paiement directement -->
            <a href="{% url 'orders:checkout' %}" class="btn primary">Payer</a>
          {% else %}
            <!-- Lien contact mis à jour : l'app CRM n'existe plus -->
            <a href="{% url 'core:contact' %}" class="btn primary">Contactez‑nous</a>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Auth -->
    {% if request.user.is_authenticated %}
      <span class="nav-hello">Bonjour, {{ request.user.username }}</span>

      <!-- Lien vers mon compte -->
      <a href="{% url 'userauths:account' %}" class="icon-btn" aria-label="Mon compte">
        <!-- Icône profil moderne -->
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 21v-2a4 4 0 0 0-3-3.87"/>
          <path d="M4 21v-2a4 4 0 0 1 3-3.87"/>
          <circle cx="12" cy="7" r="4"/>
        </svg>
      </a>

      <!-- Logout en POST -->
      <form method="post" action="{% url 'userauths:logout' %}" class="nav-logout-form">
        {% csrf_token %}
        <button type="submit" class="icon-btn" aria-label="Se déconnecter">
          <!-- Icône logout moderne -->
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
               stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
            <polyline points="16 17 21 12 16 7"/>
            <line x1="21" y1="12" x2="9" y2="12"/>
          </svg>
        </button>
      </form>
    {% else %}
      <a class="icon-btn" href="{% url 'userauths:login' %}" aria-label="Se connecter">
        <!-- Icône login moderne -->
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
          <polyline points="10 17 15 12 10 7"/>
          <line x1="15" y1="12" x2="3" y2="12"/>
        </svg>
      </a>
      <a class="nav-link" href="{% url 'userauths:register' %}">Créer un compte</a>
    {% endif %}

  </div>
</nav>